<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Laporan V12.1 - Smart Auto Reset</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; padding: 20px; color: #333; }
        .container { max-width: 850px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #0056b3; padding-bottom: 10px; }
        .header h2 { margin: 0; color: #0056b3; text-transform: uppercase; letter-spacing: 1px; }
        .header p { margin: 5px 0 0; color: #666; font-size: 0.9em; }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #444; }
        input[type="text"], input[type="date"], input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        /* Tabel Input */
        table.input-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        table.input-table th { background: #0056b3; color: white; padding: 10px; text-align: left; }
        table.input-table td { padding: 5px; border: 1px solid #ddd; }
        
        button { cursor: pointer; padding: 10px 15px; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        .btn-add { background: #17a2b8; color: white; margin-bottom: 10px; }
        .btn-remove { background: #dc3545; color: white; padding: 5px 10px; }
        .btn-generate { background: #28a745; color: white; width: 100%; font-size: 18px; margin-top: 20px; padding: 15px; display: block; }
        .btn-generate:hover { background: #218838; }

        /* Grid Tanda Tangan */
        .signature-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
        .sig-box { border: 1px dashed #ccc; padding: 10px; text-align: center; border-radius: 5px; background: #f9f9f9; }
        .sig-box h4 { margin: 0 0 10px 0; font-size: 12px; color: #555; }
        .sig-preview { width: 100%; height: 60px; object-fit: contain; margin-top: 5px; border: 1px solid #eee; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>PT OTSUKA DISTRIBUTION INDONESIA</h2>
        <p>Form Laporan Operasional Harian (V12.1 Auto Reset)</p>
    </div>

    <div style="display: flex; gap: 20px;">
        <div class="form-group" style="flex:1;">
            <label>Tanggal Laporan:</label>
            <input type="date" id="tglLaporan">
        </div>
        <div class="form-group" style="flex:1;">
            <label>Nama Pelapor (Sales):</label>
            <input type="text" id="namaPelapor" placeholder="Contoh: Budi Santoso">
        </div>
    </div>

    <button class="btn-add" onclick="addRow()">+ Tambah Baris Aktivitas</button>
    <table class="input-table" id="dataTable">
        <thead>
            <tr>
                <th width="5%">No</th>
                <th width="40%">Keterangan Aktivitas</th>
                <th width="35%">Lokasi / Outlet</th>
                <th width="15%">Status</th>
                <th width="5%">Aksi</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <div style="margin-top: 30px; border-top: 2px solid #eee; padding-top: 10px;">
        <label>Upload Tanda Tangan (Opsional - Bisa dikosongkan untuk TTD Manual)</label>
        <div class="signature-grid">
            <div class="sig-box">
                <h4>Dibuat Oleh (Sales)</h4>
                <input type="text" id="name1" placeholder="Nama..." style="margin-bottom:5px; font-size:11px;">
                <input type="file" id="file1" accept="image/*" onchange="previewImage(this, 'prev1')" style="font-size:10px;">
                <img id="prev1" class="sig-preview">
            </div>
            <div class="sig-box">
                <h4>Diketahui (SPV)</h4>
                <input type="text" id="name2" placeholder="Nama..." style="margin-bottom:5px; font-size:11px;">
                <input type="file" id="file2" accept="image/*" onchange="previewImage(this, 'prev2')" style="font-size:10px;">
                <img id="prev2" class="sig-preview">
            </div>
            <div class="sig-box">
                <h4>Disetujui (BM)</h4>
                <input type="text" id="name3" placeholder="Nama..." style="margin-bottom:5px; font-size:11px;">
                <input type="file" id="file3" accept="image/*" onchange="previewImage(this, 'prev3')" style="font-size:10px;">
                <img id="prev3" class="sig-preview">
            </div>
            <div class="sig-box">
                <h4>Admin / OM</h4>
                <input type="text" id="name4" placeholder="Nama..." style="margin-bottom:5px; font-size:11px;">
                <input type="file" id="file4" accept="image/*" onchange="previewImage(this, 'prev4')" style="font-size:10px;">
                <img id="prev4" class="sig-preview">
            </div>
        </div>
    </div>

    <button class="btn-generate" onclick="generatePDF()">üñ®Ô∏è DOWNLOAD PDF LAPORAN</button>
</div>

<script>
    // 1. AUTO SET DATE
    window.onload = function() {
        resetFormToDefault(); // Panggil fungsi reset saat pertama kali buka
    };

    // 2. FUNGSI TABEL (Tambah/Hapus Baris)
    function addRow() {
        const tbody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
        const row = tbody.insertRow();
        const num = tbody.rows.length;
        
        row.innerHTML = `
            <td style="text-align:center">${num}</td>
            <td><input type="text" class="act" placeholder="Isi aktivitas..."></td>
            <td><input type="text" class="loc" placeholder="Nama Toko/Lokasi"></td>
            <td><input type="text" class="stat" placeholder="Selesai/Pending" value="Selesai"></td>
            <td style="text-align:center"><button class="btn-remove" onclick="removeRow(this)">X</button></td>
        `;
    }

    function removeRow(btn) {
        const row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
        renumberRows();
    }

    function renumberRows() {
        const tbody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
        for (let i = 0; i < tbody.rows.length; i++) {
            tbody.rows[i].cells[0].innerText = i + 1;
        }
    }

    // 3. PREVIEW GAMBAR
    function previewImage(input, imgId) {
        const preview = document.getElementById(imgId);
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        } else {
            preview.style.display = 'none';
        }
    }

    // 4. GENERATE PDF
    async function generatePDF() {
        // Validasi Nama Sales dulu
        const salesName = document.getElementById('namaPelapor').value;
        if(!salesName) {
            alert("Harap isi Nama Pelapor terlebih dahulu!");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // --- HEADER ---
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(0, 86, 179);
        doc.text("PT OTSUKA DISTRIBUTION INDONESIA", 105, 15, null, null, "center");
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.setFont("helvetica", "normal");
        doc.text("CABANG MEDAN - LAPORAN OPERASIONAL", 105, 22, null, null, "center");
        doc.setLineWidth(0.5);
        doc.line(15, 26, 195, 26);

        // --- INFO ---
        const tgl = document.getElementById('tglLaporan').value;
        
        doc.setFontSize(10);
        doc.text(`Tanggal : ${tgl}`, 15, 35);
        doc.text(`Nama    : ${salesName}`, 15, 40);

        // --- TABEL ---
        let tableData = [];
        const rows = document.querySelectorAll('#dataTable tbody tr');
        rows.forEach((row, index) => {
            const act = row.querySelector('.act').value;
            const loc = row.querySelector('.loc').value;
            const stat = row.querySelector('.stat').value;
            tableData.push([index+1, act, loc, stat]);
        });

        doc.autoTable({
            startY: 45,
            head: [['No', 'Keterangan Aktivitas', 'Lokasi / Outlet', 'Status']],
            body: tableData,
            theme: 'grid',
            headStyles: { fillColor: [0, 86, 179] },
            styles: { fontSize: 9, cellPadding: 3 },
            columnStyles: { 0: {halign: 'center'}, 3: {halign: 'center'} }
        });

        // --- TANDA TANGAN ---
        let finalY = doc.lastAutoTable.finalY + 10;
        if (finalY > 220) { doc.addPage(); finalY = 20; }

        const xPos = [15, 62, 110, 158];
        const roles = ["Dibuat Oleh", "Diketahui", "Disetujui", "Admin/OM"];
        
        doc.setFontSize(8);
        
        for(let i=1; i<=4; i++) {
            let x = xPos[i-1];
            doc.text(roles[i-1], x + 15, finalY, null, null, "center");
            
            const input = document.getElementById('file'+i);
            if (input.files && input.files[0]) {
                const imgData = await getBase64(input.files[0]);
                try {
                    doc.addImage(imgData, 'JPEG', x, finalY + 3, 30, 15);
                } catch (e) { console.error(e); }
            }
            
            doc.line(x, finalY + 25, x + 30, finalY + 25);
            
            const nama = document.getElementById('name'+i).value;
            const namaText = nama ? `(${nama})` : "(..................)";
            doc.text(namaText, x + 15, finalY + 29, null, null, "center");
        }

        const fileName = `Laporan_${salesName.replace(/\s+/g, '_')}_${tgl}.pdf`;
        doc.save(fileName);

        // --- LOGIKA RESET FORM SETELAH DOWNLOAD ---
        setTimeout(function() {
            // Beri jeda 1 detik agar browser sempat memulai download
            if(confirm("Laporan berhasil didownload! Form akan dikosongkan untuk laporan baru.")) {
                resetFormToDefault();
            }
        }, 1000);
    }

    // FUNGSI BERSIH-BERSIH (RESET)
    function resetFormToDefault() {
        // 1. Reset Input Text
        document.getElementById('namaPelapor').value = "";
        
        // 2. Reset Tanggal ke Hari Ini
        document.getElementById('tglLaporan').valueAsDate = new Date();

        // 3. Reset Tabel (Hapus semua, sisakan 1)
        const tbody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
        tbody.innerHTML = ""; 
        addRow(); // Tambah 1 baris kosong

        // 4. Reset Area Tanda Tangan
        for(let i=1; i<=4; i++) {
            document.getElementById('name'+i).value = ""; // Hapus Nama
            document.getElementById('file'+i).value = ""; // Hapus File
            
            // Hapus Preview Gambar
            const img = document.getElementById('prev'+i);
            img.src = "";
            img.style.display = "none";
        }
    }

    function getBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
</script>

</body>
</html>
